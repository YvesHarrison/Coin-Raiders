<!doctype html>
<meta charset="utf-8">
<title>Coin Raider</title>

<body>
  <script src="pixi.js"></script>
  <script src="./google-blockly-82871b3/blockly_compressed.js"></script>
  <script src="./google-blockly-82871b3/blocks_compressed.js"></script>
  <script src="./google-blockly-82871b3/msg/js/en.js"></script>
  
  <!-- <div id="blocklyDiv" style="height: 480px; width: 600px;"></div> -->

  <xml id="toolbox" style="display: none">
    <block type="controls_if"></block>
    <block type="controls_repeat_ext"></block>
    <block type="logic_compare"></block>
    <block type="math_number"></block>
    <block type="math_arithmetic"></block>
    <block type="text"></block>
    <block type="text_print"></block>
  </xml>
  
  <script>
    // Fixed window injection
    var workspace = Blockly.inject('blocklyDiv',
      { toolbox: document.getElementById('toolbox') });
  </script> 

  <script>
    let excutedInputData = {}

    let gameState = {
      curPlayerName: '',
      winState: [],
      playersName: [],
      playersReadyData: [],
      playersScore: [],
      playersGridData: [],
      playersInputData: [],
      playersCoinMap: {}
    }

    let Application = PIXI.Application,
      Container = PIXI.Container,
      loader = PIXI.loader,
      resources = PIXI.loader.resources,
      TextureCache = PIXI.utils.TextureCache,
      Sprite = PIXI.Sprite;
    //Create a Pixi Application
    let app = new Application({
      width: 700,
      height: 690,
      antialiasing: false,
      transparent: false,
      resolution: 1
    }
    );
    //Add the canvas that Pixi automatically created for you to the HTML document
    document.body.appendChild(app.view);
    loader
      .add("images/land1.png")
      .add("images/block2.png")
      .add("images/coin.png")
      .add("images/character1.png")
      .add("images/bg.png")
      .add("images/box1.png")
      .load(setup)
    
    let state
    const CELL_WIDTH = 32
    function setupBoard(grids, name, score, isYou) {
      name = 'test'
      score = 9887
      grids = [[0, 4, 0, 0, 0, 0, 0, 0],
               [0, 0, 0, 0, 0, 0, 0, 0],
               [0, 3, 0, 0, 0, 0, 0, 0],
               [0, 0, 0, 0, 0, 0, 0, 0],
               [0, 2, 2, 2, 2, 2, 0, 0],
               [0, 3, 0, 0, 0, 0, 0, 0],
               [0, 3, 3, 0, 0, 0, 0, 0],
               [0, 0, 3, 3, 3, 3, 3, 3]]

      let container = new PIXI.Container()

      if (isYou) {
        let box1 = new Sprite(resources["images/box1.png"].texture)
        box1.x -= 23
        box1.y -= 35
        container.addChild(box1)
      }

      // Fill the map
      let x = 0
      let y = 0
      offset = 32
      for (let i = 0; i < grids.length; i++) {
        for (let j = 0; j < grids[0].length; j++) {
          let sp = new Sprite(resources["images/land1.png"].texture)
          sp.x = x
          sp.y = y
          x += offset
          container.addChild(sp)
        }
        x = 0
        y += offset
      }

      // Fill the player, blocks and items.
      for (let i = 0; i < grids.length; i++) {
        for (let j = 0; j < grids[0].length; j++) {
          let val = grids[i][j]
          
          if (val == 2) {
            // Block
            let sp = new Sprite(resources["images/block2.png"].texture)
            sp.x = j * CELL_WIDTH
            sp.y = i * CELL_WIDTH
            container.addChild(sp)
          } else if (val == 3) {
            // Coin
            let sp = new Sprite(resources["images/coin.png"].texture)
            sp.x = j * CELL_WIDTH
            sp.y = i * CELL_WIDTH
            container.addChild(sp)

            coinMap = 
          }else if (val == 4) {
            // Player initial position
            let sp = new Sprite(resources["images/character1.png"].texture)
            sp.x = j * CELL_WIDTH
            sp.y = i * CELL_WIDTH
            container.addChild(sp)
          }
        }
      }
      
      let coinMap = []
      playersCoinMap[name] = coinMap

      // Name
      let basicText = new PIXI.Text(name)
      basicText.style.fill = 0xffffff
      basicText.style.fontSize = 20
      basicText.x = 0
      basicText.y = -25
      container.addChild(basicText)
      // Score
      let scoreText = new PIXI.Text('score: ' + score)
      scoreText.style.fill = 0xffffff;
      scoreText.style.fontSize = 20
      scoreText.x = 150
      scoreText.y = -25
      container.addChild(scoreText)

      return container
    }

    function setup() {
      //Create the `cat` sprite 
      // land1 = new Sprite(resources["images/land1.png"].texture);
      // land1.x = 96;
      // land1.y = 96;
      let board0 = setupBoard([], '', '', false)
      let board1 = setupBoard([], '', '', true)
      let board2 = setupBoard()
      let board3 = setupBoard()

      board0.x = 50
      board0.y = 90

      board1.x = 400
      board1.y = 90

      board2.x = 50
      board2.y = 400

      board3.x = 400
      board3.y = 400

      let bg = new Sprite(resources["images/bg.png"].texture)
      app.stage.addChild(bg)

      let team1text = new PIXI.Text('Team 1   Score 2000')
      team1text.style.fill = 0xffffff
      team1text.style.fontSize = 30
      team1text.x = 30
      team1text.y = 5
      app.stage.addChild(team1text)

      let team2text = new PIXI.Text('Team 2   Score 2000')
      team2text.style.fill = 0xffffff
      team2text.style.fontSize = 30
      team2text.x = 380
      team2text.y = 5
      app.stage.addChild(team2text)

      app.stage.addChild(board0)
      app.stage.addChild(board1)
      app.stage.addChild(board2)
      app.stage.addChild(board3)

      //Set the game state
      state = play

      //Start the game loop 
      app.ticker.add(delta => gameLoop(delta));
    }
    function gameLoop(delta) {
      //Update the current game state:
      state(delta)
    }
    let excutingInput = {}
    function play(delta) {
      for (let key in excutingInput) {
        
      }
    }
  
    function dataChange() {
      // This function run at after gameState updated by other function.
      // When game data changes(Get broadcast from the server)
      // Check wether the input commands get excuted. If not excuted the input command with certain speed.
      let inputDatas = gameState.playersInputData
      for (let key in inputDatas) {
        let inputData = inputDatas[key]
        if (!(key in excutedInputData)) {
          excutedInputData[key] = inputData
          excutingInput[key] = inputData
        }
      }
    }
  </script>
</body>